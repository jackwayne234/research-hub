<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Formula Memory Palace</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#1e2128;
  --card:#252932;
  --border:#2d3139;
  --indigo:#6366f1;
  --green:#22c55e;
  --pink:#ec4899;
  --amber:#f59e0b;
  --text:#e2e8f0;
  --muted:#94a3b8;
  --red:#ef4444;
}
html{scroll-behavior:smooth}
body{
  font-family:'JetBrains Mono',monospace;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  line-height:1.6;
}
a{color:var(--indigo);text-decoration:none}
a:hover{text-decoration:underline}

.container{max-width:1100px;margin:0 auto;padding:0 1rem 3rem}
.back-link{display:inline-flex;align-items:center;gap:.4rem;color:var(--muted);font-size:.8rem;padding:.75rem 0;transition:color .2s}
.back-link:hover{color:var(--text);text-decoration:none}

header{padding:1.5rem 0 1rem}
.header-title{font-size:1.6rem;font-weight:700;letter-spacing:-.02em}
.header-sub{color:var(--muted);font-size:.85rem;margin-top:.3rem}
.stat-badges{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.8rem}
.stat-badge{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:.25rem .6rem;font-size:.75rem;color:var(--muted)}

/* Palace Tabs */
.palace-tabs{display:flex;gap:0;border-bottom:2px solid var(--border);margin-top:1.2rem;overflow-x:auto;scrollbar-width:none}
.palace-tabs::-webkit-scrollbar{display:none}
.palace-tab{background:none;border:none;color:var(--muted);font-family:inherit;font-size:.85rem;padding:.8rem 1.1rem;cursor:pointer;white-space:nowrap;border-bottom:3px solid transparent;margin-bottom:-2px;transition:color .2s,border-color .2s;flex-shrink:0}
.palace-tab.active{color:#fff;border-bottom-color:var(--indigo)}
.palace-tab:hover:not(.active){color:var(--text)}

/* Mode Buttons */
.mode-row{display:flex;gap:.6rem;padding:1rem 0;flex-wrap:wrap}
.mode-btn{background:var(--card);border:1px solid var(--border);color:var(--muted);font-family:inherit;font-size:.82rem;padding:.5rem 1.1rem;border-radius:8px;cursor:pointer;transition:all .2s;flex-shrink:0}
.mode-btn.active{background:var(--indigo);border-color:var(--indigo);color:#fff}
.mode-btn:hover:not(.active){border-color:var(--indigo);color:var(--text)}

/* Progress Bar */
.progress-wrap{margin-bottom:1rem}
.progress-label{font-size:.78rem;color:var(--muted);margin-bottom:.4rem}
.progress-track{height:6px;background:var(--border);border-radius:3px;overflow:hidden}
.progress-fill{height:100%;background:var(--indigo);border-radius:3px;transition:width .5s cubic-bezier(.34,1.56,.64,1)}

/* Walk Mode */
.room-card{background:var(--card);border:1px solid var(--border);border-radius:10px;margin-bottom:.75rem;overflow:hidden}
.room-header{display:flex;align-items:center;gap:.75rem;padding:.9rem 1rem;cursor:pointer;user-select:none;transition:background .15s}
.room-header:hover{background:#2d3240}
.room-icon{font-size:1.1rem;flex-shrink:0}
.room-name{font-weight:600;font-size:.9rem;flex:1}
.room-count{color:var(--muted);font-size:.75rem;flex-shrink:0}
.room-walked-badge{background:var(--green);color:#000;font-size:.68rem;font-weight:700;padding:.15rem .45rem;border-radius:4px;flex-shrink:0}
.room-chevron{color:var(--muted);font-size:.8rem;transition:transform .35s cubic-bezier(.34,1.56,.64,1);flex-shrink:0;line-height:1}
.room-card.open .room-chevron{transform:rotate(180deg)}
.room-body{display:none;border-top:1px solid var(--border)}
.room-card.open .room-body{display:block}
.formula-table{width:100%;border-collapse:collapse}
.formula-table th{text-align:left;font-size:.7rem;color:var(--muted);font-weight:500;padding:.5rem .75rem;background:#1a1d24;border-bottom:1px solid var(--border);white-space:nowrap}
.formula-table td{padding:.55rem .75rem;font-size:.78rem;vertical-align:top;border-bottom:1px solid var(--border)}
.formula-table tr:last-child td{border-bottom:none}
.formula-table td:first-child{color:var(--pink);font-size:.72rem;white-space:nowrap;width:1%}
.formula-table td:nth-child(2){color:var(--amber);font-weight:600}
.formula-table td:nth-child(3){color:var(--muted);font-style:italic;font-size:.73rem}
.walk-btn{display:block;margin:.75rem;padding:.5rem 1rem;background:transparent;border:1px solid var(--border);color:var(--muted);font-family:inherit;font-size:.78rem;border-radius:7px;cursor:pointer;transition:all .2s;width:calc(100% - 1.5rem);text-align:center}
.walk-btn:hover{border-color:var(--green);color:var(--green)}
.walk-btn.walked{background:#14532d22;border-color:var(--green);color:var(--green)}

/* Flashcard Mode */
.flashcard-wrap{display:flex;flex-direction:column;align-items:center;padding:1rem 0}
.flashcard-scene{width:100%;max-width:580px;height:290px;perspective:1200px;cursor:pointer}
.flashcard-inner{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform .55s cubic-bezier(.34,1.56,.64,1)}
.flashcard-scene.flipped .flashcard-inner{transform:rotateY(180deg)}
.flashcard-face{position:absolute;inset:0;border-radius:14px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:1.75rem;backface-visibility:hidden;-webkit-backface-visibility:hidden}
.flashcard-front{background:var(--card);border:2px solid var(--border)}
.flashcard-back{background:#1a1d26;border:2px solid var(--indigo);transform:rotateY(180deg)}
.card-formula{font-size:1rem;font-weight:700;color:var(--amber);text-align:center;line-height:1.6}
.card-hint{font-size:.7rem;color:var(--muted);margin-top:1rem;opacity:.7}
.card-palace-badge{font-size:.7rem;font-weight:700;padding:.2rem .55rem;border-radius:5px;margin-bottom:.8rem}
.card-location{font-size:.78rem;color:var(--indigo);font-weight:600;margin-bottom:.35rem}
.card-room{font-size:.82rem;color:var(--text);font-weight:500;margin-bottom:.6rem;text-align:center}
.card-image{font-size:.76rem;color:var(--muted);font-style:italic;text-align:center;line-height:1.6}
.fc-controls{display:flex;align-items:center;gap:.75rem;margin-top:1.25rem;flex-wrap:wrap;justify-content:center}
.fc-btn{background:var(--card);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:.82rem;padding:.5rem 1.1rem;border-radius:8px;cursor:pointer;transition:all .2s}
.fc-btn:hover:not(:disabled){border-color:var(--indigo);color:var(--indigo)}
.fc-btn:disabled{opacity:.3;cursor:not-allowed}
.fc-counter{color:var(--muted);font-size:.8rem;min-width:80px;text-align:center}
.shuffle-btn{background:var(--indigo);border-color:var(--indigo);color:#fff !important}
.shuffle-btn:hover{background:#4f52d0 !important;border-color:#4f52d0 !important}

/* Drill Mode */
.drill-wrap{padding:.25rem 0}
.drill-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}
.drill-score{font-size:.82rem;color:var(--muted)}
.drill-score span{color:var(--green);font-weight:700}
.drill-question{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin-bottom:1rem;text-align:center}
.drill-q-label{font-size:.7rem;color:var(--muted);margin-bottom:.75rem;letter-spacing:.02em}
.drill-formula{font-size:.95rem;font-weight:700;color:var(--amber);line-height:1.6}
.drill-choices{display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-bottom.75rem}
.drill-choice{background:var(--card);border:2px solid var(--border);color:var(--text);font-family:inherit;font-size:.79rem;padding:.7rem 1rem;border-radius:9px;cursor:pointer;transition:border-color .15s,background .15s,color .15s;text-align:left;line-height:1.5}
.drill-choice:hover:not(:disabled){border-color:var(--indigo);background:#2a2d3a}
.drill-choice.correct{border-color:var(--green) !important;background:#14532d33 !important;color:var(--green) !important}
.drill-choice.wrong{border-color:var(--red) !important;background:#7f1d1d22 !important;color:var(--red) !important}
.drill-choice.reveal{border-color:var(--green) !important;background:#14532d33 !important;color:var(--green) !important}
.drill-choice:disabled{cursor:default}
.drill-feedback{text-align:center;font-size:.8rem;min-height:1.4rem;margin:.75rem 0}
.drill-feedback.correct-fb{color:var(--green)}
.drill-feedback.wrong-fb{color:var(--red)}
.drill-next-btn{display:block;margin:0 auto;background:var(--indigo);border:none;color:#fff;font-family:inherit;font-size:.85rem;padding:.6rem 1.6rem;border-radius:8px;cursor:pointer;transition:background .2s}
.drill-next-btn:hover{background:#4f52d0}
.drill-done{text-align:center;padding:3rem 1rem}
.drill-done-score{font-size:2.5rem;font-weight:700;color:var(--green)}
.drill-done-label{color:var(--muted);font-size:.85rem;margin-top:.5rem}
.drill-done-msg{color:var(--text);font-size:.9rem;margin-top:.4rem}
.drill-restart{margin-top:1.25rem;background:var(--card);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:.85rem;padding:.6rem 1.6rem;border-radius:8px;cursor:pointer;transition:all .2s}
.drill-restart:hover{border-color:var(--indigo);color:var(--indigo)}

/* Badge colors */
.badge-house{background:#3f2d6b;color:#a78bfa}
.badge-destroyer{background:#1e3a5f;color:#60a5fa}
.badge-submarine{background:#14532d;color:#4ade80}
.badge-station{background:#78350f;color:#fbbf24}

@media(max-width:640px){
  .header-title{font-size:1.25rem}
  .drill-choices{grid-template-columns:1fr}
  .flashcard-scene{height:250px}
  .card-formula{font-size:.88rem}
  .palace-tab{font-size:.75rem;padding:.65rem .7rem}
  .formula-table td,.formula-table th{padding:.4rem .5rem;font-size:.7rem}
  .room-name{font-size:.82rem}
}
</style>
</head>
<body>
<div class="container">
  <a href="../index.html" class="back-link">&#8592; Back to Hub</a>
  <header>
    <div class="header-title">Formula Memory Palace</div>
    <div class="header-sub">Method of Loci &mdash; 271 formulas across 4 Navy-themed palaces</div>
    <div class="stat-badges">
      <span class="stat-badge">&#127968; 76 formulas</span>
      <span class="stat-badge">&#9875; 82 formulas</span>
      <span class="stat-badge">&#127754; 67 formulas</span>
      <span class="stat-badge">&#128760; 46 formulas</span>
    </div>
  </header>

  <div class="palace-tabs" id="palaceTabs"></div>
  <div class="mode-row" id="modeRow">
    <button class="mode-btn active" data-mode="walk">&#128694; Walk</button>
    <button class="mode-btn" data-mode="flashcard">&#127183; Flashcard</button>
    <button class="mode-btn" data-mode="drill">&#127919; Drill</button>
  </div>
  <div id="mainContent"></div>
</div>

<script>
const PALACES = [
  {
    id:"house",name:"House",emoji:"ðŸ ",label:"Math",badgeClass:"badge-house",roomLabel:"Room",
    rooms:[
      {name:"The Front Porch",sub:"Number Properties",icon:"ðŸšª",formulas:[
        {loc:"Welcome mat",formula:"a + b = b + a (commutative +)",image:"Two people swap places on the mat â€” same total weight"},
        {loc:"Doorbell",formula:"a Ã— b = b Ã— a (commutative Ã—)",image:"Press the bell with left or right hand â€” same ring"},
        {loc:"Left pillar",formula:"(a + b) + c = a + (b + c) (associative +)",image:"Three boxes stacked â€” regroup any two, same tower height"},
        {loc:"Right pillar",formula:"(a Ã— b) Ã— c = a Ã— (b Ã— c) (associative Ã—)",image:"Three gears chained â€” regroup any two, same rotation"},
        {loc:"Door knocker",formula:"a(b + c) = ab + ac (distributive)",image:"The knocker splits into two strikes â€” one hit distributes to both sides"},
        {loc:"House number",formula:"a + 0 = a, a Ã— 1 = a (identity)",image:"The house number never changes â€” adding nothing or multiplying by one"},
        {loc:"Doorframe",formula:"a + (âˆ’a) = 0, a Ã— (1/a) = 1 (inverse)",image:"The door opens and closes back to where it started"},
      ]},
      {name:"The Kitchen",sub:"Fractions & Order of Operations",icon:"ðŸ³",formulas:[
        {loc:"Oven dial",formula:"PEMDAS: Parentheses â†’ Exponents â†’ Mult/Div â†’ Add/Sub",image:"The oven has 4 temperature zones â€” cook in order or the recipe fails"},
        {loc:"Measuring cups",formula:"a/b + c/d = (ad + bc) / bd",image:"Two different-sized cups â€” pour into a common cup (common denominator)"},
        {loc:"Cutting board",formula:"a/b Ã— c/d = ac / bd",image:"Straight across â€” cut top Ã— top, bottom Ã— bottom"},
        {loc:"Knife rack",formula:"a/b Ã· c/d = a/b Ã— d/c (keep-change-flip)",image:"Flip the second fraction like flipping a knife"},
        {loc:"Mixing bowl",formula:"a/b = c/d â†’ ad = bc (cross multiply)",image:"Cross the spoons in the bowl â€” an X shape"},
        {loc:"Spice rack",formula:"a% = a/100",image:"100 spice jars â€” 'percent' literally means 'per hundred'"},
        {loc:"Fridge",formula:"|a| = distance from 0 (absolute value)",image:"The fridge temperature display â€” always shows a positive number"},
      ]},
      {name:"The Living Room",sub:"Exponent Rules",icon:"ðŸ“º",formulas:[
        {loc:"Top shelf",formula:"x^a Ã— x^b = x^(a+b)",image:"Stack books on the same shelf â€” heights ADD"},
        {loc:"Middle shelf",formula:"x^a Ã· x^b = x^(aâˆ’b)",image:"Remove books from the shelf â€” heights SUBTRACT"},
        {loc:"Bottom shelf",formula:"(x^a)^b = x^(ab)",image:"A book inside a box inside a crate â€” layers MULTIPLY"},
        {loc:"Left speaker",formula:"x^0 = 1",image:"The speaker at zero volume â€” still exists (= 1), just silent"},
        {loc:"Right speaker",formula:"x^(âˆ’n) = 1/x^n",image:"Flip the speaker upside down â€” negative exponent flips to denominator"},
        {loc:"Coffee table",formula:"(xy)^n = x^n Ã— y^n",image:"Two coasters on the table â€” the power hits both equally"},
        {loc:"Lamp",formula:"x^(1/2) = âˆšx",image:"The lamp's pull chain â€” pull halfway = square root"},
        {loc:"Rug",formula:"x^(m/n) = â¿âˆš(x^m)",image:"The rug's pattern: numerator is the power, denominator is the root"},
      ]},
      {name:"The Hallway",sub:"Linear Equations & Slope",icon:"ðŸš¶",formulas:[
        {loc:"Floor tiles",formula:"y = mx + b (slope-intercept)",image:"Walk the hallway â€” m is how steep (rise/run), b is where you start (y-intercept)"},
        {loc:"Left wall",formula:"m = (yâ‚‚ âˆ’ yâ‚) / (xâ‚‚ âˆ’ xâ‚)",image:"Two picture frames on the wall â€” slope = rise between them Ã· run between them"},
        {loc:"Right wall",formula:"y âˆ’ yâ‚ = m(x âˆ’ xâ‚) (point-slope)",image:"A coat hook on the wall at a known point â€” the line hangs from it"},
        {loc:"Light switch",formula:"Ax + By = C (standard form)",image:"The switch plate â€” everything on one side, constant on the other"},
        {loc:"Ceiling light",formula:"Parallel lines: same slope (mâ‚ = mâ‚‚)",image:"Parallel light tracks on the ceiling â€” never cross, same angle"},
        {loc:"Floor crack",formula:"Perpendicular lines: mâ‚ Ã— mâ‚‚ = âˆ’1",image:"The crack meets the baseboard at a right angle â€” slopes are negative reciprocals"},
        {loc:"Mirror at end",formula:"Midpoint: ((xâ‚+xâ‚‚)/2, (yâ‚+yâ‚‚)/2)",image:"Your reflection splits the hallway exactly in half"},
        {loc:"Hallway runner rug",formula:"Distance: d = âˆš((xâ‚‚âˆ’xâ‚)Â² + (yâ‚‚âˆ’yâ‚)Â²)",image:"The rug's diagonal length â€” Pythagorean theorem in disguise"},
      ]},
      {name:"The Bedroom",sub:"Quadratics",icon:"ðŸ›ï¸",formulas:[
        {loc:"Headboard",formula:"y = axÂ² + bx + c (standard form)",image:"The curved headboard IS a parabola â€” a controls width, c is height off floor"},
        {loc:"Left nightstand",formula:"x = (âˆ’b Â± âˆš(bÂ²âˆ’4ac)) / 2a (quadratic formula)",image:"The nightstand drawer â€” the master key that opens ANY quadratic"},
        {loc:"Right nightstand",formula:"bÂ² âˆ’ 4ac (discriminant)",image:"A lamp with a dimmer: >0 = two solutions (bright), =0 = one (dim), <0 = none (off)"},
        {loc:"Pillow",formula:"y = a(x âˆ’ h)Â² + k (vertex form)",image:"The pillow sits at the vertex (h, k) â€” the turning point of the parabola"},
        {loc:"Bedframe",formula:"x = âˆ’b/2a (axis of symmetry)",image:"The bedframe's center rail â€” the parabola is symmetric around it"},
        {loc:"Left curtain",formula:"(a + b)Â² = aÂ² + 2ab + bÂ²",image:"Pull the left curtain â€” it FOIL-expands into three panels"},
        {loc:"Right curtain",formula:"(a âˆ’ b)Â² = aÂ² âˆ’ 2ab + bÂ²",image:"Pull the right curtain â€” same three panels, middle one negative"},
        {loc:"Closet",formula:"aÂ² âˆ’ bÂ² = (a + b)(a âˆ’ b) (difference of squares)",image:"Two closet doors â€” they factor apart symmetrically"},
        {loc:"Bed sheets",formula:"xâ‚ + xâ‚‚ = âˆ’b/a and xâ‚ Ã— xâ‚‚ = c/a (Vieta's formulas)",image:"The two sides of the sheet â€” roots add to âˆ’b/a, multiply to c/a"},
      ]},
      {name:"The Bathroom",sub:"Geometry",icon:"ðŸš¿",formulas:[
        {loc:"Floor tiles",formula:"aÂ² + bÂ² = cÂ² (Pythagorean theorem)",image:"The square tiles in the corner â€” two small squares combine to equal the big one"},
        {loc:"Round mirror",formula:"C = 2Ï€r (circumference)",image:"Trace your finger around the circular mirror â€” 2Ï€r all the way around"},
        {loc:"Sink basin",formula:"A = Ï€rÂ² (area of circle)",image:"The water filling the round sink basin â€” Ï€ times radius squared"},
        {loc:"Bathtub",formula:"V = lwh (rectangular volume)",image:"Fill the rectangular tub â€” length Ã— width Ã— height"},
        {loc:"Showerhead",formula:"V = 4/3 Ï€rÂ³ (sphere volume)",image:"The round showerhead â€” a sphere of water"},
        {loc:"Soap bar",formula:"A = Â½bh (triangle area)",image:"The triangular soap bar â€” half of a rectangle"},
        {loc:"Towel rack",formula:"V = Ï€rÂ²h (cylinder volume)",image:"The rolled-up towel â€” a cylinder"},
        {loc:"Toilet paper",formula:"SA = 2Ï€rÂ² + 2Ï€rh (cylinder surface area)",image:"Unroll the toilet paper â€” two circles + the rectangular wrap"},
        {loc:"Corner shelf",formula:"Sum of angles in triangle = 180Â°",image:"Three items on the triangular shelf â€” always add to 180Â°"},
      ]},
      {name:"The Garage",sub:"Trigonometry",icon:"ðŸ”§",formulas:[
        {loc:"The wheel",formula:"Unit circle: x = cos Î¸, y = sin Î¸",image:"The wheel turns â€” x-coordinate = cosine, y-coordinate = sine"},
        {loc:"Toolbox",formula:"SOH-CAH-TOA: sin=opp/hyp, cos=adj/hyp, tan=opp/adj",image:"Three tool drawers â€” each one a ratio of triangle sides"},
        {loc:"Workbench",formula:"sinÂ²Î¸ + cosÂ²Î¸ = 1 (Pythagorean identity)",image:"The bench has exactly 1 square meter of surface â€” sinÂ² and cosÂ² fill it completely"},
        {loc:"Vise grip",formula:"tan Î¸ = sin Î¸ / cos Î¸",image:"The vise squeezes sin over cos together"},
        {loc:"Left wall hooks",formula:"sin(0Â°)=0, sin(30Â°)=1/2, sin(45Â°)=âˆš2/2, sin(60Â°)=âˆš3/2, sin(90Â°)=1",image:"Five hooks going UP the wall: 0, Â½, âˆš2/2, âˆš3/2, 1"},
        {loc:"Right wall hooks",formula:"cos(0Â°)=1, cos(30Â°)=âˆš3/2, cos(45Â°)=âˆš2/2, cos(60Â°)=1/2, cos(90Â°)=0",image:"Five hooks going DOWN the wall: 1, âˆš3/2, âˆš2/2, Â½, 0 (reverse of sine!)"},
        {loc:"Ceiling fan",formula:"Period of sin/cos = 2Ï€",image:"The fan completes one full rotation in 2Ï€"},
        {loc:"Garage door",formula:"cÂ² = aÂ² + bÂ² âˆ’ 2ab cos C (Law of Cosines)",image:"The door is a triangle â€” Pythagorean theorem with a cosine correction term"},
        {loc:"Oil stain",formula:"a/sin A = b/sin B = c/sin C (Law of Sines)",image:"Three oil drips in proportion â€” each side over its opposite sine"},
      ]},
      {name:"The Attic",sub:"Logarithms & Exponentials",icon:"ðŸ“¦",formulas:[
        {loc:"Log stack",formula:"log_b(x) = y means b^y = x",image:"The stack of logs â€” 'what power do I raise the base to?'"},
        {loc:"Skylight",formula:"ln(x) = log_e(x) (natural log, base e)",image:"Natural light through the skylight â€” 'ln' is nature's logarithm"},
        {loc:"Dust motes",formula:"e â‰ˆ 2.71828...",image:"The dust particles multiply naturally â€” e is the base of natural growth"},
        {loc:"Old trunk",formula:"log(ab) = log a + log b",image:"Open the trunk â€” multiplied items inside ADD their logs"},
        {loc:"Rocking chair",formula:"log(a/b) = log a âˆ’ log b",image:"The chair rocks between two positions â€” division becomes subtraction"},
        {loc:"Ceiling beam",formula:"log(a^n) = n log a",image:"The beam's height is n times the base log â€” exponent comes down as multiplier"},
        {loc:"Cobweb",formula:"log_b(1) = 0",image:"Nothing caught in the web â€” log of 1 is always 0"},
        {loc:"Attic ladder",formula:"log_b(b) = 1",image:"One rung to reach the base â€” log of the base is always 1"},
        {loc:"Old clock",formula:"A = Pe^(rt) (continuous growth)",image:"The clock still ticks â€” principal P grows at rate r over time t"},
        {loc:"Moth-eaten quilt",formula:"A = P(1 + r/n)^(nt) (compound growth)",image:"The quilt has layers â€” n compoundings per period"},
      ]},
      {name:"The Rooftop",sub:"Pre-Calculus & Limits",icon:"ðŸŒ…",formulas:[
        {loc:"Horizon",formula:"lim(xâ†’a) f(x) = L",image:"You walk toward the horizon â€” you approach L but the journey defines the destination"},
        {loc:"Left railing",formula:"lim(xâ†’0) sin(x)/x = 1",image:"Lean over the left rail â€” sin(x)/x approaches exactly 1 as x shrinks"},
        {loc:"Right railing",formula:"lim(xâ†’âˆž) (1 + 1/n)^n = e",image:"Lean over the right rail â€” compound interest at infinite frequency = e"},
        {loc:"Antenna",formula:"f'(x) = lim(hâ†’0) [f(x+h) âˆ’ f(x)] / h (derivative definition)",image:"The antenna measures instantaneous rate of change â€” slope at a single point"},
        {loc:"Weather vane",formula:"d/dx(x^n) = nx^(nâˆ’1) (power rule)",image:"The vane spins â€” bring the power down, reduce by one"},
        {loc:"Rain gutter",formula:"âˆ« x^n dx = x^(n+1)/(n+1) + C (integration power rule)",image:"The gutter collects water â€” raise the power by one, divide, add the constant drip C"},
        {loc:"Chimney",formula:"d/dx(sin x) = cos x, d/dx(cos x) = âˆ’sin x",image:"Smoke from the chimney â€” sin becomes cos, cos becomes negative sin (they cycle)"},
        {loc:"Satellite dish",formula:"d/dx[f(g(x))] = f'(g(x)) Ã— g'(x) (chain rule)",image:"The dish receives a nested signal â€” differentiate outside, multiply by inside derivative"},
        {loc:"Flagpole",formula:"âˆ«_a^b f(x)dx = F(b) âˆ’ F(a) (fundamental theorem)",image:"The flag rises from a to b â€” area under the curve = antiderivative at endpoints"},
      ]},
    ]
  },
  {
    id:"destroyer",name:"Destroyer",emoji:"âš“",label:"Physics",badgeClass:"badge-destroyer",roomLabel:"Deck",
    rooms:[
      {name:"The Bridge",sub:"Units, Measurement & Vectors",icon:"ðŸ§­",formulas:[
        {loc:"Helm wheel",formula:"v = d/t (speed = distance / time)",image:"The helm readout shows speed â€” miles traveled over hours elapsed"},
        {loc:"Compass",formula:"R = A + B (vector addition, tip-to-tail)",image:"Plot two compass headings end-to-end â€” the resultant is where you actually end up"},
        {loc:"Radar screen",formula:"Ax = A cos Î¸, Ay = A sin Î¸ (vector components)",image:"The radar paints a blip â€” its x-distance is cosine, y-distance is sine"},
        {loc:"Chart table",formula:"|A| = âˆš(AxÂ² + AyÂ²) (vector magnitude)",image:"Measure the straight-line distance on the chart â€” Pythagorean theorem"},
        {loc:"Ship's log",formula:"Dimensional analysis: units must match on both sides",image:"The log entries â€” port and starboard columns must balance"},
        {loc:"Barometer",formula:"1 atm = 101,325 Pa = 14.7 psi",image:"The barometer reads atmospheric pressure â€” memorize the sea-level value"},
        {loc:"Binoculars",formula:"Significant figures: measurement precision",image:"Look through the binos â€” you can only resolve so many digits of detail"},
      ]},
      {name:"Weapons Deck",sub:"Kinematics",icon:"ðŸŽ¯",formulas:[
        {loc:"Gun barrel",formula:"v = vâ‚€ + at",image:"The shell accelerates down the barrel â€” initial velocity + acceleration Ã— time"},
        {loc:"Missile tube",formula:"x = vâ‚€t + Â½atÂ²",image:"The missile's position after launch â€” starts at vâ‚€, accelerates over time"},
        {loc:"Fire control computer",formula:"vÂ² = vâ‚€Â² + 2a(x âˆ’ xâ‚€)",image:"The computer solves for final velocity â€” no time variable needed"},
        {loc:"CIWS turret",formula:"R = vâ‚€Â²sin(2Î¸) / g (projectile range)",image:"The Phalanx tracks projectile range â€” max at 45Â° launch angle"},
        {loc:"Shell rack",formula:"y = vâ‚€sinÎ¸ Â· t âˆ’ Â½gtÂ² (projectile height)",image:"Shells stacked vertically â€” height follows the parabolic arc"},
        {loc:"Targeting scope",formula:"x = vâ‚€cosÎ¸ Â· t (projectile horizontal)",image:"The horizontal crosshair â€” constant velocity, no acceleration"},
        {loc:"Stopwatch",formula:"vÌ„ = Î”x/Î”t (average velocity)",image:"The stopwatch on the bulkhead â€” displacement over time interval"},
        {loc:"Speedometer",formula:"v = dx/dt (instantaneous velocity)",image:"The real-time speed readout â€” the derivative of position"},
      ]},
      {name:"Main Engineering",sub:"Forces & Newton's Laws",icon:"âš™ï¸",formulas:[
        {loc:"Main throttle",formula:"F = ma (Newton's 2nd Law)",image:"Push the throttle â€” force = mass Ã— acceleration"},
        {loc:"Shaft bearing",formula:"Newton's 3rd: Fâ‚â‚‚ = âˆ’Fâ‚‚â‚",image:"The shaft pushes the water aft, the water pushes the ship forward"},
        {loc:"Anchor chain",formula:"W = mg (weight)",image:"The anchor's weight â€” mass Ã— gravity pulling it down"},
        {loc:"Deck plates",formula:"N = mg cos Î¸ (normal force on incline)",image:"Stand on a tilted deck plate â€” the normal force is the perpendicular component"},
        {loc:"Oil drum",formula:"f = Î¼N (friction force)",image:"Push an oil drum across the deck â€” friction = coefficient Ã— normal force"},
        {loc:"Crane cable",formula:"Tension: same throughout an ideal rope",image:"The crane lifts a load â€” tension is the same at every point in the cable"},
        {loc:"Centrifuge",formula:"F = mvÂ²/r (centripetal force)",image:"The centrifuge spins â€” the force points inward, vÂ²/r"},
        {loc:"Spring mount",formula:"F = âˆ’kx (Hooke's Law)",image:"The engine mount springs â€” force proportional to displacement, opposite direction"},
        {loc:"Propeller",formula:"p = mv (momentum)",image:"The spinning propeller â€” mass Ã— velocity"},
        {loc:"Collision bulkhead",formula:"J = FÎ”t = Î”p (impulse)",image:"The bulkhead absorbs a collision â€” force Ã— time = change in momentum"},
      ]},
      {name:"Navigation Center",sub:"Energy, Work & Power",icon:"ðŸ”‹",formulas:[
        {loc:"GPS receiver",formula:"W = Fd cos Î¸ (work)",image:"The GPS tracks your displacement â€” work = force along the direction of motion"},
        {loc:"Battery bank",formula:"KE = Â½mvÂ² (kinetic energy)",image:"The batteries store energy of motion â€” half mass times velocity squared"},
        {loc:"Fuel tank",formula:"PE = mgh (gravitational potential energy)",image:"The fuel stored high up â€” mass Ã— gravity Ã— height = stored potential"},
        {loc:"Generator",formula:"P = W/t = Fv (power)",image:"The generator's output â€” work per unit time, or force Ã— velocity"},
        {loc:"Efficiency meter",formula:"KEâ‚ + PEâ‚ = KEâ‚‚ + PEâ‚‚ (conservation of energy)",image:"The meter balances â€” total mechanical energy stays constant"},
        {loc:"Spring coil",formula:"PE = Â½kxÂ² (elastic potential energy)",image:"The coiled spring stores energy â€” half k times displacement squared"},
        {loc:"Winch",formula:"W_net = Î”KE (work-energy theorem)",image:"The winch does net work â€” equals the change in kinetic energy"},
      ]},
      {name:"Communications",sub:"Waves & Sound",icon:"ðŸ“¡",formulas:[
        {loc:"Radio antenna",formula:"v = fÎ» (wave speed)",image:"The antenna broadcasts â€” speed = frequency Ã— wavelength"},
        {loc:"Sonar dome",formula:"f' = f(v Â± v_obs)/(v âˆ“ v_source) (Doppler effect)",image:"The sonar ping shifts pitch â€” approaching = higher, receding = lower"},
        {loc:"Speaker",formula:"T = 1/f (period = 1/frequency)",image:"One full speaker vibration â€” period is the inverse of frequency"},
        {loc:"Oscilloscope",formula:"y = A sin(2Ï€ft + Ï†) (wave equation)",image:"The green wave on the scope â€” amplitude A, frequency f, phase shift Ï†"},
        {loc:"Tuning fork",formula:"f_n = n(v/2L) (standing wave harmonics)",image:"The fork vibrates at its natural frequency â€” harmonics are integer multiples"},
        {loc:"Sound tube",formula:"v â‰ˆ 343 m/s (speed of sound in air at 20Â°C)",image:"Sound travels down the comm tube â€” ~343 meters per second"},
        {loc:"Headphones",formula:"I = P/A (wave intensity)",image:"The volume in the headphones â€” power spread over area"},
        {loc:"Decibel meter",formula:"Î² = 10 logâ‚â‚€(I/Iâ‚€) dB",image:"The meter reads in decibels â€” logarithmic scale, Iâ‚€ = 10â»Â¹Â² W/mÂ²"},
      ]},
      {name:"Medical Bay",sub:"Thermodynamics",icon:"ðŸŒ¡ï¸",formulas:[
        {loc:"Thermometer",formula:"Â°F = (9/5)Â°C + 32, K = Â°C + 273.15",image:"The thermometer has three scales â€” convert between them"},
        {loc:"Heat lamp",formula:"Q = mcÎ”T (heat transfer)",image:"The heat lamp warms a patient â€” mass Ã— specific heat Ã— temperature change"},
        {loc:"Ice pack",formula:"Q = mL (latent heat)",image:"The ice pack melts â€” mass Ã— latent heat, no temp change during phase transition"},
        {loc:"Blood pressure cuff",formula:"PV = nRT (ideal gas law)",image:"Inflate the cuff â€” pressure Ã— volume = moles Ã— gas constant Ã— temperature"},
        {loc:"Autoclave",formula:"1st Law: Î”U = Q âˆ’ W",image:"The autoclave sterilizes â€” internal energy = heat in minus work out"},
        {loc:"Body",formula:"2nd Law: Î”S â‰¥ 0 (entropy increases)",image:"The body ages â€” disorder always increases in an isolated system"},
        {loc:"Defibrillator",formula:"e = W/Q_H = 1 âˆ’ Q_C/Q_H (efficiency)",image:"The defib converts stored energy to work â€” never 100% efficient"},
        {loc:"Carnot diagram",formula:"e_Carnot = 1 âˆ’ T_C/T_H (max efficiency)",image:"The ideal engine â€” efficiency depends only on temperature ratio"},
      ]},
      {name:"Combat Information Center",sub:"Electricity & Magnetism",icon:"âš¡",formulas:[
        {loc:"Main display",formula:"F = kqâ‚qâ‚‚/rÂ² (Coulomb's law)",image:"Two blips on the screen â€” force between charges, inverse square"},
        {loc:"Power conduit",formula:"E = F/q = kQ/rÂ² (electric field)",image:"The conduit radiates an E-field â€” force per unit charge"},
        {loc:"Capacitor bank",formula:"V = kQ/r (electric potential)",image:"The capacitors store voltage â€” energy per unit charge"},
        {loc:"Circuit breaker",formula:"V = IR (Ohm's law)",image:"The breaker trips â€” voltage = current Ã— resistance"},
        {loc:"Fuse box",formula:"P = IV = IÂ²R = VÂ²/R (electrical power)",image:"The fuse rates â€” power dissipated in the circuit"},
        {loc:"Battery rack",formula:"Series: R_total = Râ‚ + Râ‚‚ + ...",image:"Batteries in series â€” resistances ADD"},
        {loc:"Parallel bus",formula:"Parallel: 1/R_total = 1/Râ‚ + 1/Râ‚‚ + ...",image:"Parallel power buses â€” reciprocals add"},
        {loc:"Electromagnet",formula:"F = qv Ã— B (magnetic force on charge)",image:"The electromagnet grabs â€” force = charge Ã— velocity cross magnetic field"},
        {loc:"Solenoid coil",formula:"F = BIL sin Î¸ (force on current-carrying wire)",image:"Current through the coil in a B-field â€” force on the wire"},
        {loc:"Transformer",formula:"Î¦ = BA cos Î¸ (magnetic flux)",image:"The transformer core â€” flux = field Ã— area Ã— cos of angle"},
        {loc:"Generator",formula:"Îµ = âˆ’dÎ¦/dt (Faraday's law)",image:"The generator spins â€” changing flux induces voltage"},
        {loc:"Capacitor",formula:"C = Q/V, E = Â½CVÂ² (capacitance & energy)",image:"The capacitor stores charge and energy"},
      ]},
      {name:"Reactor Compartment",sub:"Nuclear & Modern Physics",icon:"â˜¢ï¸",formulas:[
        {loc:"Reactor core",formula:"E = mcÂ² (mass-energy equivalence)",image:"The reactor converts mass to energy â€” a tiny amount = enormous energy"},
        {loc:"Fuel rod",formula:"E = hf (photon energy)",image:"Each fuel rod emits photons â€” energy = Planck's constant Ã— frequency"},
        {loc:"Control rod",formula:"Î» = h/p (de Broglie wavelength)",image:"The control rod's quantum nature â€” everything has a wavelength = h/momentum"},
        {loc:"Shielding",formula:"N = Nâ‚€(Â½)^(t/tÂ½) (radioactive decay)",image:"The shielding blocks radiation that decays â€” half gone every half-life"},
        {loc:"Dosimeter",formula:"KE_max = hf âˆ’ Ï† (photoelectric effect)",image:"The dosimeter detects photons kicking electrons â€” energy minus work function"},
        {loc:"Neutron counter",formula:"Î”E Â· Î”t â‰¥ â„/2 (energy-time uncertainty)",image:"The counter can't measure both energy and time precisely"},
        {loc:"Coolant pipe",formula:"Î”xÎ”p â‰¥ â„/2 (Heisenberg uncertainty principle)",image:"The coolant particles â€” can't know exact position AND momentum simultaneously"},
      ]},
      {name:"Flight Deck",sub:"Optics & Light",icon:"âœˆï¸",formulas:[
        {loc:"Signal lamp",formula:"c = 3 Ã— 10â¸ m/s (speed of light)",image:"The signal lamp flashes â€” light travels 300 million meters per second"},
        {loc:"Landing mirror",formula:"Î¸_i = Î¸_r (law of reflection)",image:"The landing mirror â€” angle in = angle out"},
        {loc:"Periscope lens",formula:"nâ‚ sin Î¸â‚ = nâ‚‚ sin Î¸â‚‚ (Snell's law)",image:"Light bends entering the periscope lens â€” index Ã— sin angle stays constant"},
        {loc:"Binocular lens",formula:"1/f = 1/d_o + 1/d_i (thin lens equation)",image:"Focus the binoculars â€” focal length relates object and image distances"},
        {loc:"Magnification dial",formula:"m = âˆ’d_i/d_o = h_i/h_o (magnification)",image:"Turn the magnification dial â€” image distance over object distance"},
        {loc:"Rainbow in spray",formula:"n = c/v (index of refraction)",image:"Rainbows in the deck spray â€” light slows down in water, n = c/v"},
        {loc:"Aircraft lights",formula:"E = hc/Î» (photon energy from wavelength)",image:"The colored aircraft lights â€” shorter wavelength = higher energy"},
        {loc:"Slit in bulkhead",formula:"d sin Î¸ = mÎ» (double-slit interference)",image:"Light through a narrow slit â€” constructive interference at integer multiples"},
      ]},
      {name:"Captain's Quarters",sub:"Relativity & Gravity",icon:"ðŸŒŒ",formulas:[
        {loc:"Captain's clock",formula:"t' = t/âˆš(1 âˆ’ vÂ²/cÂ²) (time dilation)",image:"The captain's clock runs differently â€” time slows at high speed"},
        {loc:"Porthole",formula:"L' = Lâˆš(1 âˆ’ vÂ²/cÂ²) (length contraction)",image:"Looking through the porthole â€” it appears shorter at high speed"},
        {loc:"Star chart",formula:"F = Gmâ‚mâ‚‚/rÂ² (Newton's gravitation)",image:"Two stars on the chart â€” gravitational pull, inverse square"},
        {loc:"Orbit plot",formula:"g = GM/rÂ² (gravitational field strength)",image:"The orbit computer â€” gravitational acceleration depends on mass and distance"},
        {loc:"GPS display",formula:"TÂ² = (4Ï€Â²/GM)rÂ³ (Kepler's 3rd law)",image:"The satellite orbits on the GPS â€” period squared proportional to radius cubed"},
        {loc:"Einstein portrait",formula:"G_Î¼Î½ = 8Ï€G/câ´ Â· T_Î¼Î½ (Einstein field equations)",image:"The portrait â€” geometry = energy content"},
        {loc:"Ship's motto plaque",formula:"dsÂ² = âˆ’cÂ²dtÂ² + drÂ² + rÂ²dÎ©Â² (Schwarzschild metric)",image:"Engraved on the plaque â€” the metric that started it all"},
      ]},
    ]
  },
  {
    id:"submarine",name:"Submarine",emoji:"ðŸŒŠ",label:"Chemistry",badgeClass:"badge-submarine",roomLabel:"Compartment",
    rooms:[
      {name:"Forward Torpedo Room",sub:"Atomic Structure",icon:"ðŸŸ",formulas:[
        {loc:"Torpedo tube 1",formula:"Atomic number Z = number of protons",image:"The tube is labeled with a number â€” that's how many warheads (protons) fit inside"},
        {loc:"Torpedo tube 2",formula:"Mass number A = protons + neutrons",image:"The total weight of the torpedo â€” warheads + ballast combined"},
        {loc:"Loading tray",formula:"Isotopes: same Z, different A",image:"Same torpedo model, different weights â€” extra ballast changes mass but not identity"},
        {loc:"Warhead",formula:"E = hf (photon energy)",image:"The warhead's energy â€” Planck's constant Ã— frequency of detonation"},
        {loc:"Guidance system",formula:"Î» = h/mv (de Broglie wavelength)",image:"The guidance wave â€” everything has a wavelength = h over momentum"},
        {loc:"Fire control panel",formula:"Electron config: 1sÂ² 2sÂ² 2pâ¶ 3sÂ²... (Aufbau principle)",image:"The firing sequence â€” fill lowest energy levels first"},
        {loc:"Torpedo rack",formula:"Hund's rule: fill orbitals singly before pairing",image:"Torpedoes spread across tubes one each before doubling up"},
      ]},
      {name:"Sonar Room",sub:"Periodic Table & Trends",icon:"ðŸ”Š",formulas:[
        {loc:"Sonar display",formula:"Periods = rows, Groups = columns",image:"The display grid â€” horizontal sweeps (periods), vertical channels (groups)"},
        {loc:"Headphones",formula:"Electronegativity increases â†’ and â†‘",image:"Louder signals to the upper right â€” fluorine screams the loudest"},
        {loc:"Frequency dial",formula:"Ionization energy increases â†’ and â†‘",image:"Turn the dial right and up â€” harder to knock electrons loose"},
        {loc:"Range finder",formula:"Atomic radius increases â† and â†“",image:"Farther contacts are lower-left â€” bigger atoms, more shells"},
        {loc:"Depth gauge",formula:"Electron affinity increases â†’ (generally)",image:"Deeper readings toward the right â€” atoms want electrons more"},
        {loc:"Signal log",formula:"Valence electrons = group number (main group)",image:"The log tracks signals by channel â€” group number tells you the outer electron count"},
      ]},
      {name:"Control Room",sub:"Chemical Bonding",icon:"ðŸ•¹ï¸",formulas:[
        {loc:"Helm",formula:"Ionic bond: metal + nonmetal (electron transfer)",image:"The helm transfers orders â€” one side gives, the other receives"},
        {loc:"Periscope",formula:"Covalent bond: nonmetal + nonmetal (electron sharing)",image:"Two lookouts share the periscope â€” they share electrons equally"},
        {loc:"Ballast controls",formula:"Polar covalent: unequal sharing (Î”EN = 0.4â€“1.7)",image:"The ballast is unevenly distributed â€” one side pulls harder"},
        {loc:"Navigation chart",formula:"Lewis structures: show all valence electrons",image:"The chart maps every connection â€” dots and lines for each electron"},
        {loc:"Depth controls",formula:"VSEPR: electron groups determine molecular shape",image:"The depth planes arrange around center â€” linear, trigonal, tetrahedral"},
        {loc:"Trim tank",formula:"Formal charge = valence eâ» âˆ’ (lone eâ» + Â½ bonding eâ»)",image:"The trim calculation â€” balance the charge distribution"},
        {loc:"Compass",formula:"Bond order = (bonding eâ» âˆ’ antibonding eâ») / 2",image:"The compass needle â€” higher order = stronger, shorter bond"},
      ]},
      {name:"Galley",sub:"Stoichiometry",icon:"ðŸ½ï¸",formulas:[
        {loc:"Recipe card",formula:"Balanced equation: reactants â†’ products (atoms conserve)",image:"The recipe â€” ingredients on the left, dish on the right, nothing lost"},
        {loc:"Scale",formula:"Molar mass: grams per mole (g/mol)",image:"Weigh the ingredients â€” each element has its own mass from the periodic table"},
        {loc:"Measuring cup",formula:"n = m/M (moles = mass Ã· molar mass)",image:"Pour into the cup â€” grams divided by grams-per-mole = moles"},
        {loc:"Avogadro's salt shaker",formula:"1 mol = 6.022 Ã— 10Â²Â³ particles (Avogadro's number)",image:"The salt shaker holds Avogadro's number of grains â€” one mole"},
        {loc:"Mixing bowl",formula:"Limiting reagent: runs out first, controls yield",image:"The bowl only holds so much â€” the smallest ingredient limits the dish"},
        {loc:"Yield meter",formula:"% yield = (actual/theoretical) Ã— 100",image:"The meter on the oven â€” how much you actually got vs what you should have"},
        {loc:"Dilution pitcher",formula:"Mâ‚Vâ‚ = Mâ‚‚Vâ‚‚ (dilution equation)",image:"Add water to the pitcher â€” concentration Ã— volume stays constant"},
        {loc:"Molarity label",formula:"M = mol solute / L solution (molarity)",image:"The label reads moles per liter â€” that's molarity"},
      ]},
      {name:"Air Purification",sub:"Gas Laws",icon:"ðŸ’¨",formulas:[
        {loc:"Main vent",formula:"PV = nRT (ideal gas law)",image:"The master equation on the vent cover â€” pressure Ã— volume = moles Ã— R Ã— temperature"},
        {loc:"Pressure gauge",formula:"Pâ‚Vâ‚ = Pâ‚‚Vâ‚‚ (Boyle's law)",image:"Squeeze the gauge â€” pressure up, volume down"},
        {loc:"Thermostat",formula:"Vâ‚/Tâ‚ = Vâ‚‚/Tâ‚‚ (Charles's law)",image:"Turn up the heat â€” gas expands proportionally"},
        {loc:"COâ‚‚ scrubber",formula:"Pâ‚/Tâ‚ = Pâ‚‚/Tâ‚‚ (Gay-Lussac's law)",image:"The sealed scrubber â€” heat it up, pressure rises"},
        {loc:"Oxygen generator",formula:"P_total = Pâ‚ + Pâ‚‚ + Pâ‚ƒ (Dalton's law of partial pressures)",image:"Three gas lines feed the room â€” total pressure is the sum of each"},
        {loc:"Diffusion filter",formula:"Rateâ‚/Rateâ‚‚ = âˆš(Mâ‚‚/Mâ‚) (Graham's law)",image:"Lighter gases pass through faster â€” rate inversely proportional to âˆšmass"},
        {loc:"R constant plaque",formula:"R = 0.0821 LÂ·atm/molÂ·K = 8.314 J/molÂ·K",image:"The plaque on the wall â€” memorize both values of R"},
        {loc:"Depth pressure",formula:"STP: 0Â°C (273.15 K), 1 atm",image:"Standard conditions â€” the baseline everyone agrees on"},
      ]},
      {name:"Reactor Compartment",sub:"Thermochemistry",icon:"ðŸ”¥",formulas:[
        {loc:"Reactor core",formula:"Î”H = q_p (enthalpy = heat at constant pressure)",image:"The core releases heat â€” enthalpy change IS the heat flow"},
        {loc:"Heat exchanger",formula:"q = mcÎ”T (heat = mass Ã— specific heat Ã— temp change)",image:"The exchanger transfers heat â€” same formula as physics"},
        {loc:"Coolant loop",formula:"Î”H_rxn = Î£Î”H_f(products) âˆ’ Î£Î”H_f(reactants) (Hess's law)",image:"The loop: add up product formation heats, subtract reactant heats"},
        {loc:"Steam generator",formula:"Exothermic: Î”H < 0 (releases heat)",image:"The generator puts out steam â€” energy leaves the system (negative)"},
        {loc:"Condenser",formula:"Endothermic: Î”H > 0 (absorbs heat)",image:"The condenser absorbs heat â€” energy enters the system (positive)"},
        {loc:"Entropy meter",formula:"Î”G = Î”H âˆ’ TÎ”S (Gibbs free energy)",image:"The master meter â€” free energy tells you if a reaction is spontaneous"},
        {loc:"Spontaneity light",formula:"Î”G < 0 â†’ spontaneous, Î”G > 0 â†’ non-spontaneous",image:"Green light = go (spontaneous), red light = stop"},
        {loc:"Calorimeter",formula:"q_system = âˆ’q_surroundings (energy conservation)",image:"The calorimeter box â€” energy is conserved, just transferred"},
      ]},
      {name:"Ballast Tanks",sub:"Equilibrium & Kinetics",icon:"âš–ï¸",formulas:[
        {loc:"Flood valve",formula:"Rate = k[A]^m[B]^n (rate law)",image:"The flood rate depends on how far you open the valve â€” concentration powers"},
        {loc:"Blow valve",formula:"At equilibrium: rate_forward = rate_reverse",image:"Both valves balanced â€” water in = water out, no net change"},
        {loc:"Depth gauge",formula:"K_eq = [products]^n / [reactants]^m",image:"The gauge reads the ratio â€” products over reactants at equilibrium"},
        {loc:"Trim indicator",formula:"K > 1 â†’ products favored; K < 1 â†’ reactants favored",image:"Indicator leans right (products) or left (reactants)"},
        {loc:"Le Chatelier alarm",formula:"Stress â†’ system shifts to oppose the change (Le Chatelier's principle)",image:"The alarm goes off â€” the sub adjusts to counteract whatever disturbed it"},
        {loc:"Half-life timer",formula:"tâ‚/â‚‚ = 0.693/k (first-order half-life)",image:"The timer counts down â€” half the reactant gone every half-life"},
        {loc:"Activation energy dial",formula:"k = Ae^(âˆ’Ea/RT) (Arrhenius equation)",image:"The dial controls how much energy you need to start the reaction"},
      ]},
      {name:"Battery Room",sub:"Acids, Bases & Solutions",icon:"ðŸ”‹",formulas:[
        {loc:"Battery acid",formula:"pH = âˆ’log[Hâº]",image:"The acid level â€” pH is the negative log of hydrogen ion concentration"},
        {loc:"pH strip",formula:"pH + pOH = 14 (at 25Â°C)",image:"The strip has two ends that add to 14 â€” acid side + base side"},
        {loc:"Anode",formula:"Acid: donates Hâº (BrÃ¸nsted-Lowry definition)",image:"The anode gives away â€” acids give away protons"},
        {loc:"Cathode",formula:"Base: accepts Hâº (BrÃ¸nsted-Lowry definition)",image:"The cathode receives â€” bases accept protons"},
        {loc:"Electrolyte tank",formula:"K_w = [Hâº][OHâ»] = 1.0 Ã— 10â»Â¹â´",image:"The tank holds pure water's balance â€” always 10â»Â¹â´ at 25Â°C"},
        {loc:"Buffer solution",formula:"pH = pK_a + log([Aâ»]/[HA]) (Henderson-Hasselbalch)",image:"The buffer resists change â€” pH depends on the conjugate ratio"},
        {loc:"Titration burette",formula:"At equivalence point: moles acid = moles base",image:"The burette drips until equal â€” neutralization is complete"},
        {loc:"Ksp shelf",formula:"K_sp = [cation]^m[anion]^n (solubility product)",image:"The shelf of precipitates â€” each salt has its solubility limit"},
      ]},
      {name:"Engine Room",sub:"Electrochemistry & Nuclear",icon:"âš™ï¸",formulas:[
        {loc:"Motor",formula:"Oxidation = loss of electrons (OIL)",image:"The motor spins by giving up electrons â€” Oxidation Is Loss"},
        {loc:"Generator",formula:"Reduction = gain of electrons (RIG)",image:"The generator receives electrons â€” Reduction Is Gain"},
        {loc:"Voltage meter",formula:"EÂ°_cell = EÂ°_cathode âˆ’ EÂ°_anode",image:"The meter reads cell voltage â€” cathode minus anode"},
        {loc:"Faraday's panel",formula:"Î”GÂ° = âˆ’nFEÂ° (free energy from cell potential)",image:"The panel converts voltage to energy â€” n moles Ã— Faraday's constant Ã— voltage"},
        {loc:"Nernst gauge",formula:"E = EÂ° âˆ’ (RT/nF)ln(Q) (Nernst equation)",image:"The gauge adjusts voltage for non-standard conditions"},
        {loc:"Nuclear reactor",formula:"Â²Â³âµU + Â¹n â†’ fission products + 3Â¹n",image:"The reactor splits uranium â€” mass converts to energy"},
        {loc:"Decay clock",formula:"N = Nâ‚€(Â½)^(t/tÂ½) (radioactive decay)",image:"Same as physics â€” half gone every half-life"},
        {loc:"Mass-energy plaque",formula:"E = mcÂ² (mass-energy equivalence)",image:"The plaque by the reactor â€” a tiny mass = enormous energy"},
      ]},
    ]
  },
  {
    id:"station",name:"Space Station",emoji:"ðŸ›¸",label:"Higher Math",badgeClass:"badge-station",roomLabel:"Module",
    rooms:[
      {name:"Command Module",sub:"Linear Algebra",icon:"ðŸ–¥ï¸",formulas:[
        {loc:"Main screen",formula:"Ax = b (matrix equation)",image:"The screen displays the master system â€” matrix A transforms vector x into vector b"},
        {loc:"Keyboard",formula:"det(A) = ad âˆ’ bc (2Ã—2 determinant)",image:"The two keys you cross-multiply â€” diagonal products minus each other"},
        {loc:"Joystick",formula:"Aâ»Â¹ = (1/det A) Ã— adj(A) (matrix inverse)",image:"The joystick reverses the transformation â€” inverse exists only if det â‰  0"},
        {loc:"Status lights",formula:"Eigenvalue: Av = Î»v",image:"The lights pulse at their natural frequency â€” Î» is the eigenvalue, v is the eigenvector"},
        {loc:"Crew roster",formula:"det(A âˆ’ Î»I) = 0 (characteristic equation)",image:"The roster determines who stays â€” solve for Î» to find eigenvalues"},
        {loc:"Docking clamps",formula:"(AB)áµ€ = Báµ€Aáµ€ (transpose reverses order)",image:"The clamps reverse â€” transpose of a product = product of transposes in reverse"},
        {loc:"Life support panel",formula:"rank(A) + nullity(A) = n (rank-nullity theorem)",image:"The panel balances â€” what the matrix maps + what it kills = total dimension"},
        {loc:"Navigation vectors",formula:"u Â· v = |u||v|cos Î¸ (dot product)",image:"Two navigation vectors â€” dot product gives the projection, cosine of angle between"},
        {loc:"Cross-product display",formula:"u Ã— v = |u||v|sin Î¸ nÌ‚ (cross product)",image:"The display shows the perpendicular â€” magnitude is the parallelogram area"},
        {loc:"Gram-Schmidt unit",formula:"Orthonormalization: turn any basis into orthonormal vectors",image:"The unit straightens and normalizes â€” perpendicular unit vectors"},
      ]},
      {name:"Propulsion Module",sub:"Differential Equations",icon:"ðŸš€",formulas:[
        {loc:"Throttle",formula:"dy/dx + P(x)y = Q(x) (first-order linear ODE)",image:"The throttle controls the rate â€” y changes based on its current value plus a forcing function"},
        {loc:"Integrating factor dial",formula:"Î¼(x) = e^(âˆ«P(x)dx) (integrating factor)",image:"Turn the dial â€” the integrating factor makes the left side a perfect derivative"},
        {loc:"Fuel gauge",formula:"y = Ce^(kx) (exponential growth/decay solution)",image:"The fuel drains exponentially â€” C is initial amount, k is the rate"},
        {loc:"Thrust vectoring",formula:"ay'' + by' + cy = 0 (2nd-order homogeneous ODE)",image:"The vectoring system oscillates â€” characteristic equation arÂ² + br + c = 0"},
        {loc:"Oscillation damper",formula:"y = e^(Î±t)(Câ‚cos Î²t + Câ‚‚sin Î²t) (underdamped solution)",image:"The damper lets the engine oscillate while decaying â€” exponential Ã— trig"},
        {loc:"Resonance alarm",formula:"Particular solution: guess matches forcing function form",image:"The alarm rings at resonance â€” when force matches natural frequency, amplitude blows up"},
        {loc:"Laplace console",formula:"L{f(t)} = âˆ«â‚€^âˆž e^(âˆ’st)f(t)dt (Laplace transform)",image:"The console transforms time-domain to s-domain"},
        {loc:"Inverse button",formula:"Lâ»Â¹{F(s)} = f(t) (inverse Laplace transform)",image:"Press the button â€” transform back from frequency to time"},
        {loc:"Separation valve",formula:"Separable ODE: dy/dx = f(x)g(y) â†’ âˆ«dy/g(y) = âˆ«f(x)dx",image:"The valve separates variables â€” x stuff on one side, y stuff on the other"},
      ]},
      {name:"Observation Deck",sub:"Multivariable Calculus",icon:"ðŸ”­",formulas:[
        {loc:"Left window",formula:"âˆ‚f/âˆ‚x (partial derivative: hold y constant)",image:"Look left â€” the view changes only in the x-direction"},
        {loc:"Right window",formula:"âˆ‚f/âˆ‚y (partial derivative: hold x constant)",image:"Look right â€” the view changes only in the y-direction"},
        {loc:"Floor viewport",formula:"âˆ‡f = (âˆ‚f/âˆ‚x, âˆ‚f/âˆ‚y, âˆ‚f/âˆ‚z) (gradient)",image:"Look down â€” the gradient points in the direction of steepest ascent"},
        {loc:"Telescope",formula:"âˆ‡ Â· F = âˆ‚Fâ‚/âˆ‚x + âˆ‚Fâ‚‚/âˆ‚y + âˆ‚Fâ‚ƒ/âˆ‚z (divergence)",image:"The telescope measures how much flows outward â€” sources vs sinks"},
        {loc:"Compass rose",formula:"âˆ‡ Ã— F (curl â€” measures rotation in a vector field)",image:"The compass spins â€” curl measures rotation in a vector field"},
        {loc:"Star map",formula:"âˆ¬_R f(x,y) dA (double integral)",image:"The star map covers an area â€” integrate over a 2D region"},
        {loc:"Holographic globe",formula:"âˆ­_V f(x,y,z) dV (triple integral)",image:"The globe fills a volume â€” integrate over a 3D region"},
        {loc:"Green's theorem plaque",formula:"âˆ®_C FÂ·dr = âˆ¬_R (âˆ‚Q/âˆ‚x âˆ’ âˆ‚P/âˆ‚y) dA (Green's theorem)",image:"Line integral around = double integral inside"},
        {loc:"Stokes' theorem plaque",formula:"âˆ®_C FÂ·dr = âˆ¬_S (âˆ‡Ã—F)Â·dS (Stokes' theorem)",image:"The 3D generalization â€” line integral = surface integral of curl"},
        {loc:"Divergence theorem plaque",formula:"âˆ¯_S FÂ·dS = âˆ­_V (âˆ‡Â·F) dV (Divergence theorem)",image:"Surface flux out = volume integral of divergence"},
      ]},
      {name:"Communications Array",sub:"Complex Analysis & Fourier",icon:"ðŸ“»",formulas:[
        {loc:"Antenna dish",formula:"e^(iÎ¸) = cos Î¸ + i sin Î¸ (Euler's formula)",image:"The dish rotates â€” complex exponential traces a circle"},
        {loc:"Transmitter",formula:"e^(iÏ€) + 1 = 0 (Euler's identity)",image:"The most beautiful equation â€” five fundamental constants"},
        {loc:"Signal analyzer",formula:"z = a + bi (complex number)",image:"Every signal has two parts â€” real (a) and imaginary (bi)"},
        {loc:"Modulus meter",formula:"|z| = âˆš(aÂ² + bÂ²) (complex modulus)",image:"The meter reads the distance from origin â€” Pythagorean theorem in the complex plane"},
        {loc:"Frequency spectrum",formula:"f(x) = Î£(aâ‚™cos nx + bâ‚™sin nx) (Fourier series)",image:"The spectrum breaks any signal into sine and cosine frequencies"},
        {loc:"FFT processor",formula:"F(Ï‰) = âˆ«_{âˆ’âˆž}^{âˆž} f(t)e^(âˆ’iÏ‰t)dt (Fourier transform)",image:"The processor converts time to frequency â€” the continuous version"},
        {loc:"Phase display",formula:"arg(z) = arctan(b/a) (complex argument/phase)",image:"The display shows the angle â€” phase of the complex number"},
      ]},
      {name:"Mission Control",sub:"Probability & Statistics",icon:"ðŸŽ²",formulas:[
        {loc:"Mission clock",formula:"P(A) = favorable outcomes / total outcomes",image:"The clock ticks through possibilities â€” probability is the fraction that works"},
        {loc:"Risk display",formula:"P(Aâˆ©B) = P(A)P(B|A) (conditional probability)",image:"The display shows overlapping risks â€” joint = first Ã— second given first"},
        {loc:"Bayes panel",formula:"P(A|B) = P(B|A)P(A) / P(B) (Bayes' theorem)",image:"The panel updates beliefs â€” flip the conditional using prior knowledge"},
        {loc:"Bell curve monitor",formula:"f(x) = (1/Ïƒâˆš2Ï€)e^(âˆ’(xâˆ’Î¼)Â²/2ÏƒÂ²) (normal distribution)",image:"The monitor shows the bell curve â€” Î¼ is center, Ïƒ is spread"},
        {loc:"Mean indicator",formula:"Î¼ = Î£xáµ¢/n (population mean)",image:"The indicator averages all readings â€” sum divided by count"},
        {loc:"Variance dial",formula:"ÏƒÂ² = Î£(xáµ¢ âˆ’ Î¼)Â²/n (variance)",image:"The dial measures spread â€” average of squared deviations from mean"},
        {loc:"Standard deviation",formula:"Ïƒ = âˆš(ÏƒÂ²) (standard deviation)",image:"The square root of variance â€” same units as the data"},
        {loc:"Confidence interval",formula:"xÌ„ Â± z*(Ïƒ/âˆšn) (confidence interval)",image:"The interval brackets the truth â€” sample mean Â± margin of error"},
        {loc:"Poisson counter",formula:"P(X=k) = (Î»áµe^(âˆ’Î»))/k! (Poisson distribution)",image:"The counter tracks rare events â€” Î» is the average rate"},
        {loc:"Binomial display",formula:"P(X=k) = C(n,k)p^k(1âˆ’p)^(nâˆ’k) (binomial distribution)",image:"The display shows k successes in n trials"},
      ]},
    ]
  }
];

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getAllCards(palace) {
  const cards = [];
  palace.rooms.forEach((room, ri) => {
    room.formulas.forEach(f => {
      cards.push({
        palaceId: palace.id,
        palaceName: palace.name,
        palaceEmoji: palace.emoji,
        badgeClass: palace.badgeClass,
        roomIndex: ri,
        roomName: room.name,
        roomSub: room.sub,
        loc: f.loc,
        formula: f.formula,
        image: f.image
      });
    });
  });
  return cards;
}

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function springPop(el) {
  el.animate([
    {transform:'scale(1)'},
    {transform:'scale(1.15)'},
    {transform:'scale(0.95)'},
    {transform:'scale(1.04)'},
    {transform:'scale(1)'}
  ], {duration:400, easing:'cubic-bezier(.34,1.56,.64,1)'});
}

function shake(el) {
  el.animate([
    {transform:'translateX(0)'},
    {transform:'translateX(-8px)'},
    {transform:'translateX(8px)'},
    {transform:'translateX(-6px)'},
    {transform:'translateX(6px)'},
    {transform:'translateX(0)'}
  ], {duration:350});
}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let activePalace = 0;
let activeMode = 'walk';
let fcCards = [], fcIndex = 0, fcFlipped = false;
let drillCards = [], drillIndex = 0, drillScore = 0, drillAnswered = false;

// â”€â”€ localStorage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function walkedKey(pi, ri) { return `palace_walked_${pi}_${ri}`; }
function isWalked(pi, ri) { return localStorage.getItem(walkedKey(pi, ri)) === 'true'; }
function setWalked(pi, ri) { localStorage.setItem(walkedKey(pi, ri), 'true'); }

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTabs() {
  const el = document.getElementById('palaceTabs');
  el.innerHTML = PALACES.map((p, i) => `
    <button class="palace-tab${i === activePalace ? ' active' : ''}" data-i="${i}">
      ${p.emoji} ${p.name}
      <span style="color:var(--muted);font-size:.7rem;margin-left:.2rem">(${p.label})</span>
    </button>
  `).join('');
  el.querySelectorAll('.palace-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      activePalace = +btn.dataset.i;
      renderTabs();
      renderContent();
    });
  });
}

// â”€â”€ Mode row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initModeRow() {
  document.getElementById('modeRow').querySelectorAll('.mode-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      activeMode = btn.dataset.mode;
      document.getElementById('modeRow').querySelectorAll('.mode-btn')
        .forEach(b => b.classList.toggle('active', b.dataset.mode === activeMode));
      renderContent();
    });
  });
}

// â”€â”€ Walk â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderWalk(palace) {
  const pi = activePalace;
  const walkedCount = palace.rooms.filter((_, ri) => isWalked(pi, ri)).length;
  const total = palace.rooms.length;
  const pct = total ? Math.round(walkedCount / total * 100) : 0;

  let html = `
    <div class="progress-wrap">
      <div class="progress-label">${walkedCount} / ${total} ${palace.roomLabel.toLowerCase()}s walked &mdash; ${pct}%</div>
      <div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div>
    </div>
  `;

  palace.rooms.forEach((room, ri) => {
    const w = isWalked(pi, ri);
    html += `
      <div class="room-card" id="room-card-${ri}">
        <div class="room-header" data-ri="${ri}">
          <span class="room-icon">${room.icon}</span>
          <span class="room-name">${palace.roomLabel} ${ri + 1}: ${room.name}
            <span style="display:block;font-size:.72rem;color:var(--muted);font-weight:400">${room.sub}</span>
          </span>
          <span class="room-count">${room.formulas.length} formulas</span>
          ${w ? '<span class="room-walked-badge">WALKED</span>' : ''}
          <span class="room-chevron">&#9660;</span>
        </div>
        <div class="room-body">
          <table class="formula-table">
            <thead>
              <tr><th>Location</th><th>Formula</th><th>Memory Image</th></tr>
            </thead>
            <tbody>
              ${room.formulas.map(f => `
                <tr>
                  <td>${f.loc}</td>
                  <td>${f.formula}</td>
                  <td>${f.image}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          <button class="walk-btn${w ? ' walked' : ''}" data-ri="${ri}">
            ${w ? '&#10003; Walked' : 'Mark as Walked'}
          </button>
        </div>
      </div>
    `;
  });

  document.getElementById('mainContent').innerHTML = html;

  document.querySelectorAll('.room-header').forEach(hdr => {
    hdr.addEventListener('click', () => {
      hdr.closest('.room-card').classList.toggle('open');
    });
  });

  document.querySelectorAll('.walk-btn').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      const ri = +btn.dataset.ri;
      setWalked(pi, ri);
      springPop(btn);
      setTimeout(() => renderWalk(palace), 450);
    });
  });
}

// â”€â”€ Flashcard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFlashcard(palace) {
  fcCards = getAllCards(palace);
  fcIndex = 0;
  fcFlipped = false;
  buildFlashcardUI();
}

function buildFlashcardUI() {
  document.getElementById('mainContent').innerHTML = `
    <div class="flashcard-wrap">
      <div class="flashcard-scene" id="fcScene">
        <div class="flashcard-inner" id="fcInner">
          <div class="flashcard-face flashcard-front" id="fcFront"></div>
          <div class="flashcard-face flashcard-back" id="fcBack"></div>
        </div>
      </div>
      <div class="fc-controls">
        <button class="fc-btn" id="fcPrev">&#8592; Prev</button>
        <span class="fc-counter" id="fcCounter"></span>
        <button class="fc-btn" id="fcNext">Next &#8594;</button>
        <button class="fc-btn shuffle-btn" id="fcShuffle">&#128256; Shuffle</button>
      </div>
      <div style="text-align:center;margin-top:.75rem;font-size:.7rem;color:var(--muted)">Click card to flip</div>
    </div>
  `;

  updateFlashcard();

  document.getElementById('fcScene').addEventListener('click', () => {
    fcFlipped = !fcFlipped;
    document.getElementById('fcScene').classList.toggle('flipped', fcFlipped);
  });

  document.getElementById('fcPrev').addEventListener('click', () => {
    if (fcIndex > 0) { fcIndex--; resetFlip(); updateFlashcard(); }
  });

  document.getElementById('fcNext').addEventListener('click', () => {
    if (fcIndex < fcCards.length - 1) { fcIndex++; resetFlip(); updateFlashcard(); }
  });

  document.getElementById('fcShuffle').addEventListener('click', () => {
    fcCards = shuffle(fcCards);
    fcIndex = 0;
    resetFlip();
    springPop(document.getElementById('fcShuffle'));
    updateFlashcard();
  });
}

function resetFlip() {
  fcFlipped = false;
  const scene = document.getElementById('fcScene');
  if (scene) scene.classList.remove('flipped');
}

function updateFlashcard() {
  if (!fcCards.length) return;
  const c = fcCards[fcIndex];
  document.getElementById('fcCounter').textContent = `${fcIndex + 1} of ${fcCards.length}`;
  document.getElementById('fcPrev').disabled = fcIndex === 0;
  document.getElementById('fcNext').disabled = fcIndex === fcCards.length - 1;

  document.getElementById('fcFront').innerHTML = `
    <div style="font-size:.68rem;color:var(--muted);margin-bottom:.8rem">${c.palaceEmoji} ${c.palaceName} &mdash; ${c.roomName}</div>
    <div class="card-formula">${c.formula}</div>
    <div class="card-hint">Click to reveal location &amp; memory image</div>
  `;

  document.getElementById('fcBack').innerHTML = `
    <span class="card-palace-badge ${c.badgeClass}">${c.palaceEmoji} ${c.palaceName}</span>
    <div class="card-location">${c.loc}</div>
    <div class="card-room">${c.roomName}</div>
    <div class="card-image">${c.image}</div>
  `;
}

// â”€â”€ Drill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDrill(palace) {
  drillCards = shuffle(getAllCards(palace));
  drillIndex = 0;
  drillScore = 0;
  drillAnswered = false;
  renderDrillQuestion(palace);
}

function renderDrillQuestion(palace) {
  const wrap = document.getElementById('mainContent');

  if (drillIndex >= drillCards.length) {
    const pct = Math.round(drillScore / drillCards.length * 100);
    let msg = pct >= 90 ? 'Outstanding, sailor. Shipshape performance.' :
              pct >= 75 ? 'Good work. Keep drilling those weaker spots.' :
              pct >= 60 ? 'Decent effort. More reps needed.' :
              'Hit the books again. You can do this.';
    wrap.innerHTML = `
      <div class="drill-done">
        <div class="drill-done-score">${drillScore} / ${drillCards.length}</div>
        <div style="font-size:1.5rem;margin:.3rem 0">${pct}%</div>
        <div class="drill-done-msg">${msg}</div>
        <button class="drill-restart" id="drillRestart">&#9654; Drill Again</button>
      </div>
    `;
    document.getElementById('drillRestart').addEventListener('click', () => renderDrill(palace));
    return;
  }

  const card = drillCards[drillIndex];
  const allRooms = palace.rooms.map((r, i) => ({name: r.name, index: i}));
  const correct = allRooms[card.roomIndex];
  const others = shuffle(allRooms.filter(r => r.index !== card.roomIndex)).slice(0, 3);
  const choices = shuffle([correct, ...others]);
  const pct = Math.round(drillIndex / drillCards.length * 100);

  wrap.innerHTML = `
    <div class="drill-wrap">
      <div class="drill-header">
        <div class="drill-score">Score: <span>${drillScore}</span> / ${drillIndex}</div>
        <div style="color:var(--muted);font-size:.78rem">${drillIndex + 1} of ${drillCards.length}</div>
      </div>
      <div class="progress-wrap" style="margin-bottom:.75rem">
        <div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div>
      </div>
      <div class="drill-question">
        <div class="drill-q-label">${palace.emoji} Which ${palace.roomLabel.toLowerCase()} does this formula belong to?</div>
        <div class="drill-formula">${card.formula}</div>
      </div>
      <div class="drill-choices" id="drillChoices">
        ${choices.map(ch => `
          <button class="drill-choice" data-room="${ch.index}">
            ${palace.roomLabel} ${ch.index + 1}: ${ch.name}
          </button>
        `).join('')}
      </div>
      <div class="drill-feedback" id="drillFeedback"></div>
      <button class="drill-next-btn" id="drillNext" style="display:none">
        ${drillIndex + 1 < drillCards.length ? 'Next Formula &#8594;' : 'See Results'}
      </button>
    </div>
  `;

  document.querySelectorAll('.drill-choice').forEach(btn => {
    btn.addEventListener('click', () => {
      if (drillAnswered) return;
      drillAnswered = true;

      const chosen = +btn.dataset.room;
      const isCorrect = chosen === card.roomIndex;
      const feedback = document.getElementById('drillFeedback');
      document.querySelectorAll('.drill-choice').forEach(b => b.disabled = true);

      if (isCorrect) {
        drillScore++;
        btn.classList.add('correct');
        feedback.textContent = 'Correct! Well done, sailor.';
        feedback.className = 'drill-feedback correct-fb';
        springPop(btn);
      } else {
        btn.classList.add('wrong');
        shake(btn);
        feedback.textContent = `Wrong. Correct answer: ${palace.roomLabel} ${card.roomIndex + 1}: ${card.roomName}`;
        feedback.className = 'drill-feedback wrong-fb';
        document.querySelectorAll('.drill-choice').forEach(b => {
          if (+b.dataset.room === card.roomIndex) b.classList.add('reveal');
        });
      }

      document.getElementById('drillNext').style.display = 'block';
      document.getElementById('drillNext').addEventListener('click', () => {
        drillIndex++;
        drillAnswered = false;
        renderDrillQuestion(palace);
      });
    });
  });
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderContent() {
  const palace = PALACES[activePalace];
  if (activeMode === 'walk') renderWalk(palace);
  else if (activeMode === 'flashcard') renderFlashcard(palace);
  else renderDrill(palace);
}

renderTabs();
initModeRow();
renderContent();
</script>
</body>
</html>
